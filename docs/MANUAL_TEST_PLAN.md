# 手动测试计划 - Phase 1.1.2 Excel 导入自动保存

## 测试目标

验证 Excel 导入功能与自动保存功能是否正常工作，确保数据持久化和音频设置保存功能符合预期。

## 测试环境

- 操作系统：Windows/macOS
- 应用版本：1.0.0
- 测试数据：data/ 目录下的 Excel 文件

## 测试前准备

1. 确保应用已正确打包或处于开发模式
2. 准备测试用的 Excel 文件（学生名单和单词列表）
3. 清空之前的持久化数据（可选，用于测试首次导入）

## 测试步骤

### 测试 1: Excel 导入自动保存功能

#### 步骤

1. **启动应用**
   - 启动 word-warrior 应用
   - 预期结果：应用正常启动，显示文件上传提示框

2. **导入两个 Excel 文件**
   - 点击"1. 学生名单 Excel"选择文件
   - 选择 `data/students.xlsx`（或其他学生名单文件）
   - 点击"2. 单词列表 Excel"选择文件
   - 选择 `data/words.xlsx`（或其他单词列表文件）
   - 点击"确定"按钮
   - 预期结果：
     - 按钮显示"导入中..."状态
     - 导入完成后显示绿色成功 toast 提示："✅ 数据已自动保存！\n学生: X 名\n单词: Y 个"
     - 文件上传提示框自动关闭
     - 应用进入主界面

3. **验证数据持久化**
   - 关闭应用
   - 重新启动应用
   - 预期结果：
     - 应用启动后不再显示文件上传提示框
     - 显示绿色 toast 提示："✅ 已恢复上次导入的数据：学生 X 名 / 单词 Y 个"
     - 主界面正常显示

4. **验证抽取功能**
   - 点击"开始冒险"按钮
   - 等待 2 秒滚动动画
   - 预期结果：随机选中一个学生并显示
   - 点击"抽取单词"按钮
   - 预期结果：随机选中一个单词并显示
   - 点击"继续冒险"返回主界面

5. **检查持久化存储文件**
   - 打开电子存储目录：
     - Windows: `%APPDATA%/word-warrior-store`
     - macOS: `~/Library/Application Support/word-warrior-store`
   - 预期结果：
     - 找到 `config.json` 文件
     - 文件中包含 `students`、`words`、`importMetadata` 字段
     - `importMetadata.students` 包含：
       - `filename`: 文件名
       - `importedAt`: 导入时间戳
       - `sourceType`: "excel"
       - `count`: 学生数量
     - `importMetadata.words` 包含相同结构

6. **查看日志**
   - 打开开发者工具（如果在开发模式）或查看应用日志
   - 预期结果：
     - 看到 "[DataImporter] 成功保存 students" 日志
     - 看到 "[DataImporter] 成功保存 words" 日志
     - 无错误信息

### 测试 2: 测试数据自动保存功能

#### 步骤

1. **清空持久化数据**
   - 删除 `config.json` 文件或重命名
   - 重新启动应用

2. **使用测试数据**
   - 在文件上传提示框中点击"使用测试数据"按钮
   - 预期结果：
     - 显示绿色 toast："✅ 测试数据已自动保存！\n学生: 8名\n单词: 10个"
     - 文件上传提示框关闭

3. **验证测试数据持久化**
   - 关闭应用
   - 重新启动应用
   - 预期结果：
     - 显示 toast："✅ 已恢复上次导入的数据：学生 8 名 / 单词 10 个"
     - 可以正常抽取学生和单词

4. **检查存储文件中的元数据**
   - 打开 `config.json`
   - 预期结果：
     - `importMetadata.students.sourceType` 为 "test"
     - `importMetadata.words.sourceType` 为 "test"
     - `importMetadata.students.filename` 为 "test-data"

### 测试 3: 音频设置自动保存功能

#### 步骤

1. **修改音乐开关**
   - 点击右上角音乐按钮（🔊）关闭音乐
   - 预期结果：
     - 按钮变为 🔇
     - 音乐停止播放
     - 按钮样式变为半透明（muted 类）

2. **验证音乐设置持久化**
   - 关闭应用
   - 重新启动应用
   - 预期结果：
     - 音乐按钮显示为 🔇（关闭状态）
     - 音乐不自动播放

3. **重新打开音乐**
   - 点击音乐按钮
   - 预期结果：
     - 按钮变为 🔊
     - 音乐开始播放
     - 按钮恢复正常样式

4. **检查设置持久化**
   - 打开 `config.json`
   - 预期结果：
     - `settings.musicEnabled` 字段为 true
     - `settings.lastUpdated` 有最新的时间戳
     - `settings.volume` 字段存在（默认 1）
     - `settings.playMode` 字段存在（默认 "loop"）

### 测试 4: 错误处理和友好提示

#### 步骤

1. **测试未选择文件**
   - 清空数据，重启应用
   - 在文件上传提示框中直接点击"确定"（不选择文件）
   - 预期结果：显示红色错误 toast："请同时选择学生名单和单词列表两个 Excel 文件"

2. **测试只选择一个文件**
   - 只选择学生名单文件
   - 点击"确定"
   - 预期结果：显示相同的错误提示

3. **测试无效 Excel 文件**
   - 准备一个空的或格式不正确的 Excel 文件
   - 选择该文件作为学生名单或单词列表
   - 点击"确定"
   - 预期结果：
     - 显示红色错误 toast，包含具体错误信息
     - 文件上传提示框不关闭，允许重新选择

4. **测试所有学生/单词被抽完**
   - 导入少量数据（如测试数据：8 个学生）
   - 连续抽取 8 次学生
   - 尝试第 9 次抽取
   - 预期结果：显示红色 toast："所有学生都已被抽取，已无可抽取的学生"

### 测试 5: 重复导入和数据覆盖

#### 步骤

1. **首次导入数据**
   - 导入第一组 Excel 文件（如 students.xlsx）
   - 验证数据正常保存

2. **第二次导入不同数据**
   - 准备另一组不同的 Excel 文件
   - （可选）手动显示文件上传提示框
   - 导入新的 Excel 文件
   - 预期结果：
     - 新数据覆盖旧数据
     - `importMetadata` 中的时间戳和文件名更新
     - 重启应用后加载的是新数据

3. **验证元数据更新**
   - 打开 `config.json`
   - 预期结果：
     - `importMetadata.students.filename` 是新文件名
     - `importMetadata.students.importedAt` 是新的时间戳

### 测试 6: 启动恢复对话层（Phase 1.1.3）

#### 场景 1：正常恢复
1. 启动应用（确保之前已成功导入过数据）
2. 预期看到“恢复上次数据”对话层，展示学生与单词数量
3. 点击“恢复”
4. 预期结果：
   - 对话层关闭
   - 显示绿色提示“已恢复上次数据：学生 X 名 / 单词 Y 个”
   - 主界面正常，音乐设置保持上次状态

#### 场景 2：重新导入
1. 启动应用，出现对话层
2. 点击“重新导入”
3. 预期结果：
   - 对话层关闭
   - 弹出导入引导（文件上传提示框）
   - 内存中的学生/单词列表清空（不会清空历史记录标记）

#### 场景 3：开始新会话
1. 启动应用，出现对话层
2. 点击“开始新会话”
3. 预期结果：
   - 对话层关闭
   - 已清空持久化中的学生、单词和会话历史
   - 弹出导入引导（文件上传提示框）

#### 场景 4：数据不完整或损坏
1. 人为修改或删除 `config.json` 某些字段（如将 students 改为对象）
2. 启动应用
3. 预期结果：
   - 顶部显示橙色提示“检测到历史数据不完整，建议重新导入”
   - 自动进入重新导入模式（显示导入引导）
   - 对话层显示“历史数据异常”，只提供“重新导入”和“开始新会话”按钮

## 测试验收标准

### 功能性验收

- ✅ Excel 文件导入成功后数据自动保存到持久化存储
- ✅ 应用重启后自动加载之前保存的数据
- ✅ 测试数据导入成功并持久化
- ✅ 音乐开关状态持久化
- ✅ 所有成功操作显示友好的 toast 提示
- ✅ 所有错误情况显示清晰的错误信息

### 数据完整性验收

- ✅ 持久化存储文件 `config.json` 存在且格式正确
- ✅ `students` 和 `words` 数组内容完整
- ✅ `importMetadata` 包含所有必需字段：
  - filename
  - filepath（可为 null）
  - importedAt（ISO 时间戳）
  - sourceType（"excel" 或 "test"）
  - count（数量）
- ✅ `settings` 包含音频设置：
  - musicEnabled（布尔值）
  - volume（0-1）
  - playMode（字符串）
  - lastUpdated（时间戳）

### 日志验收

- ✅ 控制台日志中无 JavaScript 错误
- ✅ 持久化操作成功的日志信息清晰
- ✅ 数据导入成功的日志信息包含详细信息

## 已知问题和注意事项

1. 浏览器可能阻止自动播放音乐，需要用户首次交互后才能播放
2. Excel 文件必须是 .xlsx 或 .xls 格式
3. Excel 第一列必须包含数据，第一行作为表头会被跳过
4. 清空持久化数据需要手动删除配置文件

## 测试报告模板

```
测试日期：____________________
测试人员：____________________
应用版本：____________________
操作系统：____________________

| 测试项目 | 测试结果 | 备注 |
|---------|---------|------|
| 测试 1: Excel 导入自动保存 | ☐ 通过 ☐ 失败 | |
| 测试 2: 测试数据自动保存 | ☐ 通过 ☐ 失败 | |
| 测试 3: 音频设置自动保存 | ☐ 通过 ☐ 失败 | |
| 测试 4: 错误处理和友好提示 | ☐ 通过 ☐ 失败 | |
| 测试 5: 重复导入和数据覆盖 | ☐ 通过 ☐ 失败 | |

问题和建议：
_________________________________________________
_________________________________________________
_________________________________________________
```

## 自动化测试建议（未来）

1. 使用 Electron 的 Spectron 或 Playwright 进行 E2E 测试
2. 模拟文件选择和导入流程
3. 验证持久化存储内容
4. 自动检查日志输出
5. 测试各种异常情况和边界条件

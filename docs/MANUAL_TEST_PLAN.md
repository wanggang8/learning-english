# 手动测试计划 - Phase 1.1.2 Excel 导入自动保存

## 测试目标

验证 Excel 导入功能与自动保存功能是否正常工作，确保数据持久化和音频设置保存功能符合预期。

## 测试环境

- 操作系统：Windows/macOS
- 应用版本：1.0.0
- 测试数据：data/ 目录下的 Excel 文件

## 测试前准备

1. 确保应用已正确打包或处于开发模式
2. 准备测试用的 Excel 文件（学生名单和单词列表）
3. 清空之前的持久化数据（可选，用于测试首次导入）

## 测试步骤

### 测试 1: Excel 导入自动保存功能

#### 步骤

1. **启动应用**
   - 启动 word-warrior 应用
   - 预期结果：应用正常启动，显示文件上传提示框

2. **导入两个 Excel 文件**
   - 点击"1. 学生名单 Excel"选择文件
   - 选择 `data/students.xlsx`（或其他学生名单文件）
   - 点击"2. 单词列表 Excel"选择文件
   - 选择 `data/words.xlsx`（或其他单词列表文件）
   - 点击"确定"按钮
   - 预期结果：
     - 按钮显示"导入中..."状态
     - 导入完成后显示绿色成功 toast 提示："✅ 数据已自动保存！\n学生: X 名\n单词: Y 个"
     - 文件上传提示框自动关闭
     - 应用进入主界面

3. **验证数据持久化**
   - 关闭应用
   - 重新启动应用
   - 预期结果：
     - 应用启动后不再显示文件上传提示框
     - 显示绿色 toast 提示："✅ 已恢复上次导入的数据：学生 X 名 / 单词 Y 个"
     - 主界面正常显示

4. **验证抽取功能**
   - 点击"开始冒险"按钮
   - 等待 2 秒滚动动画
   - 预期结果：随机选中一个学生并显示
   - 点击"抽取单词"按钮
   - 预期结果：随机选中一个单词并显示
   - 点击"继续冒险"返回主界面

5. **检查持久化存储文件**
   - 打开电子存储目录：
     - Windows: `%APPDATA%/word-warrior-store`
     - macOS: `~/Library/Application Support/word-warrior-store`
   - 预期结果：
     - 找到 `config.json` 文件
     - 文件中包含 `students`、`words`、`importMetadata` 字段
     - `importMetadata.students` 包含：
       - `filename`: 文件名
       - `importedAt`: 导入时间戳
       - `sourceType`: "excel"
       - `count`: 学生数量
     - `importMetadata.words` 包含相同结构

6. **查看日志**
   - 打开开发者工具（如果在开发模式）或查看应用日志
   - 预期结果：
     - 看到 "[DataImporter] 成功保存 students" 日志
     - 看到 "[DataImporter] 成功保存 words" 日志
     - 无错误信息

### 测试 2: 测试数据自动保存功能

#### 步骤

1. **清空持久化数据**
   - 删除 `config.json` 文件或重命名
   - 重新启动应用

2. **使用测试数据**
   - 在文件上传提示框中点击"使用测试数据"按钮
   - 预期结果：
     - 显示绿色 toast："✅ 测试数据已自动保存！\n学生: 8名\n单词: 10个"
     - 文件上传提示框关闭

3. **验证测试数据持久化**
   - 关闭应用
   - 重新启动应用
   - 预期结果：
     - 显示 toast："✅ 已恢复上次导入的数据：学生 8 名 / 单词 10 个"
     - 可以正常抽取学生和单词

4. **检查存储文件中的元数据**
   - 打开 `config.json`
   - 预期结果：
     - `importMetadata.students.sourceType` 为 "test"
     - `importMetadata.words.sourceType` 为 "test"
     - `importMetadata.students.filename` 为 "test-data"

### 测试 3: 音频设置自动保存功能

#### 步骤

1. **修改音乐开关**
   - 点击右上角音乐按钮（🔊）关闭音乐
   - 预期结果：
     - 按钮变为 🔇
     - 音乐停止播放
     - 按钮样式变为半透明（muted 类）

2. **验证音乐设置持久化**
   - 关闭应用
   - 重新启动应用
   - 预期结果：
     - 音乐按钮显示为 🔇（关闭状态）
     - 音乐不自动播放

3. **重新打开音乐**
   - 点击音乐按钮
   - 预期结果：
     - 按钮变为 🔊
     - 音乐开始播放
     - 按钮恢复正常样式

4. **检查设置持久化**
   - 打开 `config.json`
   - 预期结果：
     - `settings.musicEnabled` 字段为 true
     - `settings.lastUpdated` 有最新的时间戳
     - `settings.volume` 字段存在（默认 1）
     - `settings.playMode` 字段存在（默认 "loop"）

### 测试 4: 错误处理和友好提示

#### 步骤

1. **测试未选择文件**
   - 清空数据，重启应用
   - 在文件上传提示框中直接点击"确定"（不选择文件）
   - 预期结果：显示红色错误 toast："请同时选择学生名单和单词列表两个 Excel 文件"

2. **测试只选择一个文件**
   - 只选择学生名单文件
   - 点击"确定"
   - 预期结果：显示相同的错误提示

3. **测试无效 Excel 文件**
   - 准备一个空的或格式不正确的 Excel 文件
   - 选择该文件作为学生名单或单词列表
   - 点击"确定"
   - 预期结果：
     - 显示红色错误 toast，包含具体错误信息
     - 文件上传提示框不关闭，允许重新选择

4. **测试所有学生/单词被抽完**
   - 导入少量数据（如测试数据：8 个学生）
   - 连续抽取 8 次学生
   - 尝试第 9 次抽取
   - 预期结果：显示红色 toast："所有学生都已被抽取，已无可抽取的学生"

### 测试 5: 重复导入和数据覆盖

#### 步骤

1. **首次导入数据**
   - 导入第一组 Excel 文件（如 students.xlsx）
   - 验证数据正常保存

2. **第二次导入不同数据**
   - 准备另一组不同的 Excel 文件
   - （可选）手动显示文件上传提示框
   - 导入新的 Excel 文件
   - 预期结果：
     - 新数据覆盖旧数据
     - `importMetadata` 中的时间戳和文件名更新
     - 重启应用后加载的是新数据

3. **验证元数据更新**
   - 打开 `config.json`
   - 预期结果：
     - `importMetadata.students.filename` 是新文件名
     - `importMetadata.students.importedAt` 是新的时间戳

### 测试 6: 启动恢复对话层（Phase 1.1.3）

#### 场景 1：正常恢复
1. 启动应用（确保之前已成功导入过数据）
2. 预期看到“恢复上次数据”对话层，展示学生与单词数量
3. 点击“恢复”
4. 预期结果：
   - 对话层关闭
   - 显示绿色提示“已恢复上次数据：学生 X 名 / 单词 Y 个”
   - 主界面正常，音乐设置保持上次状态

#### 场景 2：重新导入
1. 启动应用，出现对话层
2. 点击“重新导入”
3. 预期结果：
   - 对话层关闭
   - 弹出导入引导（文件上传提示框）
   - 内存中的学生/单词列表清空（不会清空历史记录标记）

#### 场景 3：开始新会话
1. 启动应用，出现对话层
2. 点击“开始新会话”
3. 预期结果：
   - 对话层关闭
   - 已清空持久化中的学生、单词和会话历史
   - 弹出导入引导（文件上传提示框）

#### 场景 4：数据不完整或损坏
1. 人为修改或删除 `config.json` 某些字段（如将 students 改为对象）
2. 启动应用
3. 预期结果：
   - 顶部显示橙色提示“检测到历史数据不完整，建议重新导入”
   - 自动进入重新导入模式（显示导入引导）
   - 对话层显示“历史数据异常”，只提供“重新导入”和“开始新会话”按钮

## 测试验收标准

### 功能性验收

- ✅ Excel 文件导入成功后数据自动保存到持久化存储
- ✅ 应用重启后自动加载之前保存的数据
- ✅ 测试数据导入成功并持久化
- ✅ 音乐开关状态持久化
- ✅ 所有成功操作显示友好的 toast 提示
- ✅ 所有错误情况显示清晰的错误信息

### 数据完整性验收

- ✅ 持久化存储文件 `config.json` 存在且格式正确
- ✅ `students` 和 `words` 数组内容完整
- ✅ `importMetadata` 包含所有必需字段：
  - filename
  - filepath（可为 null）
  - importedAt（ISO 时间戳）
  - sourceType（"excel" 或 "test"）
  - count（数量）
- ✅ `settings` 包含音频设置：
  - musicEnabled（布尔值）
  - volume（0-1）
  - playMode（字符串）
  - lastUpdated（时间戳）

### 日志验收

- ✅ 控制台日志中无 JavaScript 错误
- ✅ 持久化操作成功的日志信息清晰
- ✅ 数据导入成功的日志信息包含详细信息

## 已知问题和注意事项

1. 浏览器可能阻止自动播放音乐，需要用户首次交互后才能播放
2. Excel 文件必须是 .xlsx 或 .xls 格式
3. Excel 第一列必须包含数据，第一行作为表头会被跳过
4. 清空持久化数据需要手动删除配置文件

## 测试报告模板

```
测试日期：____________________
测试人员：____________________
应用版本：____________________
操作系统：____________________

| 测试项目 | 测试结果 | 备注 |
|---------|---------|------|
| 测试 1: Excel 导入自动保存 | ☐ 通过 ☐ 失败 | |
| 测试 2: 测试数据自动保存 | ☐ 通过 ☐ 失败 | |
| 测试 3: 音频设置自动保存 | ☐ 通过 ☐ 失败 | |
| 测试 4: 错误处理和友好提示 | ☐ 通过 ☐ 失败 | |
| 测试 5: 重复导入和数据覆盖 | ☐ 通过 ☐ 失败 | |

问题和建议：
_________________________________________________
_________________________________________________
_________________________________________________
```

## 自动化测试建议（未来）

1. 使用 Electron 的 Spectron 或 Playwright 进行 E2E 测试
2. 模拟文件选择和导入流程
3. 验证持久化存储内容
4. 自动检查日志输出
5. 测试各种异常情况和边界条件

---

# Phase 1.1.4 手动测试 - 抽取历史持久化与会话管理

## 测试目标

- 验证每次抽取的学生与单词会即时写入持久化存储，并在重启后仍可加载
- 验证“继续上次会话 / 新建会话”分支行为正确：新建会话会自动归档旧会话
- 验证设置区域的“清空历史”功能：可清空当前会话或全部历史

## 测试步骤

1. 启动应用并导入学生与单词数据（或使用测试数据）
2. 连续执行 3-5 次完整抽取流程：
   - 点击“开始冒险”，等待抽取出学生
   - 点击“抽取单词”，记录出现的单词
   - 返回“继续冒险”，重复若干次
3. 重启应用（关闭并再次启动）
4. 启动后应出现“继续上次会话”对话：
   - 点击“继续会话”，应提示“已恢复上次数据”，可继续抽取
5. 打开设置面板，点击“清空历史”按钮：
   - 在弹窗中选择“清空当前会话”，预期结果：
     - 会话仍然存在，但历史事件计数清零
     - 再次抽取产生的新事件会从 0 开始累计
   - 再次点击“清空历史”，选择“清空全部历史”，预期结果：
     - 所有归档会话清空
     - 当前会话重置为全新会话（开始时间更新，历史为空）
6. 再次重启应用，验证历史状态保持：
   - 若仅清空了当前会话：归档仍为空，当前会话历史为空
   - 若清空全部历史：归档与当前会话历史均为空
7. 在开发者工具中验证持久化结构（可选）：
   ```javascript
   const state = window.store.getState();
   console.log(state.sessionHistory);
   // 预期：
   // {
   //   activeSession: { id, startedAt, events: [ { timestamp, student, word, fairness } ] },
   //   archivedSessions: [ { id, startedAt, endedAt, events, summary } ]
   // }
   ```

## 验收标准

- 继续会话/新建会话对话层显示正确文案
- 新建会话后旧会话被归档，学生/单词数据清空，进入导入引导
- 每次抽取均在持久化中产生一条事件记录，包含：时间戳、学生、单词、公平模式指标
- “清空历史”弹窗可选择清空当前会话或全部历史，并有对应提示
- 重启后历史状态保持与用户操作一致

---

# Phase 1.2.3 手动测试 - 历史面板 UI（抽取历史侧边栏）

## 测试目标

- 验证历史面板可显示本节课抽取历史（时间、学生、单词）
- 验证统计模式下按学生汇总并可按次数排序
- 验证清空入口工作正常（调用已有接口），面板能实时刷新
- 验证开关按钮与键盘快捷键（H/ESC）行为正确，并记忆可见性
- 验证在不同分辨率及全屏下布局合理

## 测试准备

- 已导入学生与单词数据（或使用“使用测试数据”）

## 测试步骤

1. 连续执行 3 次完整抽取流程：开始冒险 -> 抽取单词 -> 继续冒险
2. 点击左上角“🕘”历史按钮或按键盘 H，打开历史面板
   - 预期：显示“本节共 N 次 | 涉及 M 人”汇总
   - 预期：默认“按时间”列表，顶部为最近一条，行包含“时间/学生/单词”
3. 切换到“按次数”
   - 预期：列表按学生汇总（name | 次数 | 最后时间），按次数降序
4. 点击历史面板右上角“🗑”按钮，选择“清空当前会话”
   - 预期：面板列表清空，汇总变为 0 次
   - 再次抽取一条后，面板自动刷新，显示最新记录
5. 再次打开清空弹窗，选择“清空全部历史”
   - 预期：面板列表清空；开发者工具中查看 sessionHistory 归档也为空
6. 按 ESC 关闭历史面板；再次按 H 重新打开
   - 关闭应用并重启，再次启动后：历史面板可见性保持上次状态

## 验收标准

- 历史面板能够正确展示当前会话的抽取事件列表，信息完整且排序正确
- 统计模式能准确统计每个学生的抽取次数与最近时间
- 清空当前会话/全部历史后，面板内容即时刷新
- H/ESC 快捷键与左上角按钮均可切换显示状态，并记忆上次可见性
- 小屏与全屏下，侧边栏宽度/滚动行为合理，无遮挡主要交互区域
